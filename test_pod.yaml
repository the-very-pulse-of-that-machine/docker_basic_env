apiVersion: v1
kind: Pod
metadata:
  # ğŸ”´ [å¿…å¡«] ä¿®æ”¹ä¸ºä½ çš„ Pod åç§°ï¼Œå»ºè®®åŒ…å«ä½ çš„åå­—ä»¥å…å†²çª
  name: 91mrqiao-test-pod
  namespace: default
  labels:
    app: test-pod
    # ğŸŸ¢ [å¿…å¡«] å¿…é¡»åŒ…å«æ­¤æ ‡ç­¾ï¼Œå¦åˆ™ä¼šè¢«ç­–ç•¥æ‹’ç»
    eks.ebcloud.com/prepaid: "true"
spec:
  # ğŸŸ¢ [é™åˆ¶] è°ƒè¯• Pod æœ€é•¿è¿è¡Œ 12 å°æ—¶ (43200ç§’)ï¼Œè¶…æ—¶ä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨æŸ¥æ€
  activeDeadlineSeconds: 43200
  
  # ğŸ”´ [å¿…å¡«] ä¿®æ”¹æˆè‡ªå·±çš„å‡­è¯ (å¦‚æœé•œåƒæ˜¯å…¬å¼€çš„ï¼Œå¯åˆ é™¤æ­¤è¡Œ)
  imagePullSecrets:
    - name: pw-91mrqiao
  
  # è°ƒè¯• Pod å»ºè®®è®¾ç½®ä¸º Never æˆ– OnFailureï¼Œé˜²æ­¢é…ç½®é”™è¯¯å¯¼è‡´æ— é™é‡å¯
  restartPolicy: OnFailure
  
  # èŠ‚ç‚¹äº²å’Œæ€§è®¾ç½® (ç”¨äºæŒ‡å®š GPU å‹å·)ã€‚ä¸è¦è°ƒæ•´ï¼Œç›®å‰èŠ‚ç‚¹æ± å†…åªæœ‰ A800 èŠ‚ç‚¹
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
            - matchExpressions:
              - key: cloud.ebtech.com/gpu
                operator: In
                values:
                - A800_NVLINK_80GB
              # ğŸŸ¡ [å»ºè®®] å¦‚æœå› ä¸ºé©±åŠ¨å‡çº§å¯¼è‡´ Pod æ— æ³•è°ƒåº¦ï¼Œè¯·æ³¨é‡Šæ‰ä¸‹æ–¹é©±åŠ¨ç‰ˆæœ¬é™åˆ¶
              - key: cloud.ebtech.com/gpu-driver
                operator: In
                values:
                - 580.65.06 
  
  containers:
  - name: debug-pod-container
    # ğŸ”´ [å¿…å¡«] ä½ çš„é•œåƒåœ°å€
    image: crpi-4h7f6m1tjs5g4t58.cn-hangzhou.personal.cr.aliyuncs.com/91_mrqiao/basic_env:devel
    # å¦‚æœä½ çš„é•œåƒå‘ç”Ÿäº†æ”¹åŠ¨ï¼Œè¯·å°†é•œåƒæ‹‰å–ç­–ç•¥è®¾ç½®ä¸º Alwaysï¼Œå¦‚æœæ˜¯å› ä¸ºé•œåƒä»¥å¤–çš„å…¶ä»–åŸå› ï¼Œè¯·è®¾ç½®ä¸º IfNotPresent
    imagePullPolicy: IfNotPresent

    # ğŸ”´ [å¿…å¡«] ä¿®æ”¹åˆ°è‡ªå·±çš„workspace
    workingDir: /workspace/qiaohansheng/

    # è¯·ç¡®ä¿é•œåƒå†…å·²å®‰è£… sshd å¹¶é…ç½®å¥½å¯†é’¥ï¼Œå¦åˆ™ Pod ä¼šå¯åŠ¨å¤±è´¥
    command: ["/bin/bash", "-c", "sudo /usr/sbin/sshd -D"]
    
    ports:
    - containerPort: 22
      name: ssh-22

    resources:
      limits:
        # ğŸŸ¢ [é™åˆ¶] è°ƒè¯• Pod æœ€å¤šå…è®¸ç”³è¯· "2"ï¼Œè¶…è¿‡ä¼šè¢«ç­–ç•¥æ‹’ç»
        nvidia.com/gpu: "1"
        cpu: "10"
        memory: 100Gi
    
    volumeMounts:
    # 1. ä¸ªäººå·¥ä½œåŒº (è¯»å†™)
    - name: workspace-volume
      mountPath: /workspace
    # 2. æ•°æ®é›† (è°¨æ…è¯»å†™)
    - name: dataset-volume
      mountPath: /dataset
    # 3. å…¬å…±ç›˜ (å¿…é¡»åªè¯»)ï¼Œäº‘å¹³å°æä¾›
    - name: public-volume
      mountPath: /public
      readOnly: true  # ğŸ›¡ï¸ [å®‰å…¨å¼ºåˆ¶] é˜²æ­¢è¯¯åˆ ç‰©ç†æœºæ–‡ä»¶ï¼

    - mountPath: /dev/shm
      name: dshm
  
  volumes:
  - name: workspace-volume
    persistentVolumeClaim:
      claimName: cvrlab-workspace
  - name: dataset-volume
    persistentVolumeClaim:
      claimName: cvrlab-dataset
  # æŒ‚è½½å®¿ä¸»æœºç›®å½•ï¼ˆäº‘å¹³å°æä¾›ï¼‰
  - name: public-volume
    hostPath:
      path: /public
      type: Directory
  - name: dshm
    emptyDir:
      medium: Memory
      sizeLimit: 16Gi
